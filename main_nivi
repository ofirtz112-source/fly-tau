from flask import Flask, render_template, request, session, redirect
# ייבוא הפונקציות מה-DB (כולל החדשה get_all_destinations)
from DB import (search_flights, user_login, email_exists, passport_exists, create_account, manager_login,
                chosen_flight_details, airplane_dimensions, get_all_destinations)
from utils import prepare_flights_for_view, build_seatmap_layout

app = Flask(__name__)
app.secret_key = "LironOfirNivi"


# ----------------
# home_page_screen
# ----------------
@app.route("/", methods=["GET"])
def home_page():
    # קבלת הנתונים מהטופס
    trip_type = (request.args.get("trip_type") or "oneway").strip()
    date = (request.args.get("date") or "").strip()
    return_date = (request.args.get("return_date") or "").strip()
    origin = (request.args.get("origin") or "").strip()
    destination = (request.args.get("destination") or "").strip()

    searched = bool(date or origin or destination)
    destinations = get_all_destinations()

    # מקרה 1: כניסה ראשונית
    if not searched:
        return render_template("home_page.html", date="", return_date="", origin="", destination="",
                               flights=None, error=None, destinations=destinations, trip_type=trip_type)

    # מקרה 2: חסרים פרטים
    if not (date and origin and destination):
        return render_template("home_page.html", date=date, return_date=return_date, origin=origin,
                               destination=destination, flights=None, error='Please fill all the fields.',
                               destinations=destinations, trip_type=trip_type)

    # מקרה 3: חיפוש
    flights = search_flights(date, origin, destination)

    if trip_type == "round" and return_date:
        return_flights = search_flights(return_date, destination, origin)
        flights.extend(return_flights)

    flights = prepare_flights_for_view(flights)

    return render_template("home_page.html",
                           date=date,
                           return_date=return_date,
                           origin=origin,
                           destination=destination,
                           flights=flights,
                           error=None,
                           destinations=destinations,
                           trip_type=trip_type)
# -----------------
# register_login
# -----------------

@app.route("/register-login", methods=["GET", "POST"])
def register_login_page():
    if request.method == "GET":
        return render_template("register_login.html", error=None)

    email = (request.form.get("email") or "").strip()
    password = (request.form.get("password") or "").strip()

    if not email or not password:
        return render_template("register_login.html", error="Please enter email and password.")

    user = user_login(email, password)

    if user is None:
        return render_template("register_login.html", error="User not found. Please try again or continue as a guest",
                               email=email)

    session["email"] = user["email"]
    session["user_type"] = "registered"
    session["first_name"] = user["first_name_eng"]

    return redirect("/")


# -----------------
# register_logout
# -----------------

@app.route("/logout")
def logout():
    session.clear()
    return redirect("/")


# -----------
# create_account
# -----------

@app.route("/create-account", methods=["GET", "POST"])
def create_account_page():
    if request.method == "GET":
        return render_template("create_account.html", error=None)

    first_name_eng = (request.form.get("first_name") or "").strip()
    last_name_eng = (request.form.get("last_name") or "").strip()
    email = (request.form.get("email") or "").strip()
    birth_date = (request.form.get("date_of_birth") or "").strip()
    passport = (request.form.get("passport_number") or "").strip()
    password = (request.form.get("password") or "").strip()

    phone_numbers = request.form.getlist("phone_numbers")
    phone_numbers = [phone.strip() for phone in phone_numbers if phone and phone.strip()]

    if not all([first_name_eng, last_name_eng, email, birth_date, passport, password]) or not phone_numbers:
        return render_template(
            "create_account.html",
            error="Please fill all the fields.",
            first_name=first_name_eng, last_name=last_name_eng, email=email,
            date_of_birth=birth_date, passport_number=passport, )

    if email_exists(email):
        return render_template("create_account.html", error="This email is already registered.",
                               first_name=first_name_eng, last_name=last_name_eng, email=email,
                               date_of_birth=birth_date,
                               passport_number=passport)

    if passport_exists(passport):
        return render_template("create_account.html", error="This passport number is already registered.",
                               first_name=first_name_eng, last_name=last_name_eng, email=email,
                               date_of_birth=birth_date, passport_number=passport)

    create_account(email, first_name_eng, last_name_eng, birth_date, passport, password, phone_numbers)

    session["user_type"] = "registered"
    session["email"] = email
    session["first_name"] = first_name_eng

    return redirect("/")


# -----------------
# manager_login
# -----------------

@app.route("/manager-login", methods=["GET", "POST"])
def manager_login_page():
    if request.method == "GET":
        return render_template("manager_login.html", error=None, id_worker="")

    id_worker = (request.form.get("id_worker") or "").strip()
    password = (request.form.get("password") or "").strip()

    if not id_worker or not password:
        return render_template("manager_login.html", error="Please enter ID and password.", id_worker=id_worker)

    manager = manager_login(id_worker, password)

    if manager is None:
        return render_template("manager_login.html", error="Manager not found. Please try again",
                               id_worker=id_worker)

    session["id_worker"] = manager["id_worker"]
    session["user_type"] = "manager"
    session["first_name"] = manager["first_name"]

    return redirect("/")

if __name__ == "__main__":
    app.run(debug=True)

from flask import Flask, render_template, request, session, redirect, url_for, flash
import mysql.connector
from datetime import datetime, timedelta

# --- ייבוא פונקציית החיבור מהקובץ החיצוני שלך ---
from DB import get_connection

app = Flask(__name__)
app.secret_key = 'LironOfirNivi'

@app.route('/')
def home():
    return redirect(url_for('view_bookings'))


@app.route('/my-bookings', methods=['GET', 'POST'])
def view_bookings():
    email = session.get('email')
    id_booking = None

    if not email and request.method == 'POST':
        email = request.form.get('email')
        id_booking = request.form.get('id_booking')

    if email:
        # --- כאן השינוי: שימוש בפונקציה מהקובץ החיצוני ---
        conn = get_connection()
        cursor = conn.cursor(dictionary=True)

        # השאילתה שלך נשארה בדיוק אותו דבר
        query = """
            SELECT b.id_booking, b.booking_date, b.status AS booking_status, b.total_price,
                   t.passenger_name, t.passenger_passport, t.row_number, t.seat_letter, t.class_type,
                   f.departure_time, f.flight_status,
                   r.origin, r.destination
            FROM bookings b
            JOIN tickets t ON b.id_booking = t.id_booking
            JOIN flights f ON t.id_flight = f.id_flight
            JOIN routes r ON f.id_route = r.id_route
            WHERE (b.customers_email = %s OR b.registered_email = %s)
        """
        params = [email, email]

        if id_booking:
            query += " AND b.id_booking = %s"
            params.append(id_booking)

        cursor.execute(query, tuple(params))
        results = cursor.fetchall()
        cursor.close()
        conn.close()

        # עיבוד הנתונים
        bookings_dict = {}
        for row in results:
            bid = row['id_booking']
            if bid not in bookings_dict:
                bookings_dict[bid] = {
                    'info': row,
                    'tickets': []
                }
            bookings_dict[bid]['tickets'].append({
                'name': row['passenger_name'],
                'passport': row['passenger_passport'],
                'seat': f"{row['row_number']}{row['seat_letter']}",
                'class': row['class_type']
            })

        current_time = datetime.now()

        # השארתי רק לוגיקה אחת לסינון (בקוד שלך הייתה כפילות שיצרה באגים)
        # תיקנתי את השימוש ב-now שהיה חסר ל-current_time
        future = []
        past = []

        for b in bookings_dict.values():
            # המרה לתאריך אם צריך
            flight_time = b['info']['departure_time']
            if isinstance(flight_time, str):
                flight_time = datetime.strptime(flight_time, '%Y-%m-%d %H:%M:%S')

            if flight_time >= current_time:
                future.append(b)
            else:
                past.append(b)

        return render_template('bookings_results.html', future=future, past=past, email=email)

    return render_template('search_bookings.html')


@app.route('/cancel-booking', methods=['POST'])
def cancel_booking():
    booking_id = request.form.get('booking_id')

    # --- כאן השינוי: שימוש בפונקציה מהקובץ החיצוני ---
    conn = get_connection()
    cursor = conn.cursor(dictionary=True)

    cursor.execute("""
            SELECT f.departure_time, b.total_price 
            FROM bookings b 
            JOIN tickets t ON b.id_booking = t.id_booking 
            JOIN flights f ON t.id_flight = f.id_flight 
            WHERE b.id_booking = %s LIMIT 1
        """, (booking_id,))
    flight = cursor.fetchone()

    if flight:
        flight_time = flight['departure_time']
        # המרה בטיחותית לתאריך
        if isinstance(flight_time, str):
            flight_time = datetime.strptime(flight_time, '%Y-%m-%d %H:%M:%S')

        time_diff = flight_time - datetime.now()

        if time_diff > timedelta(hours=36):
            new_price = float(flight['total_price']) * 0.05
            cursor.execute("""
                        UPDATE bookings 
                        SET status = 'Cancelled_Client', total_price = %s 
                        WHERE id_booking = %s
                    """, (new_price, booking_id))
            conn.commit()
            flash(f"Order {booking_id} cancelled. 5% fee charged: {new_price} ILS.")
        else:
            flash("Cannot cancel: Flight is in less than 36 hours.")

    cursor.close()
    conn.close()
    return redirect(url_for('view_bookings'))


if __name__ == '__main__':
    app.run(debug=True, port=5001)
